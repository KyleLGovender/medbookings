/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */
'use server';

import { revalidatePath } from 'next/cache';

import { getCurrentUser } from '@/features/auth/lib/session-helper';
import { canManageUser, hasPermission, requirePermission } from '@/lib/auth/permissions';
import { sendEmail } from '@/lib/communications/email';
import { prisma } from '@/lib/prisma';
import { OrganizationRole, Permission } from '@/types/permissions';

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

/**
 * Organization member role management utilities
 *
 * Server actions for managing organization memberships, invitations,
 * and role assignments with proper permission validation.
 */

export interface MemberManagementResult {
  success: boolean;
  message: string;
  error?: string;
  data?: any;
}

export interface InvitationData {
  email: string;
  role: OrganizationRole;
  organizationId: string;
  message?: string;
}

/**
 * Invite a user to join an organization with specified role
 */
export async function inviteOrganizationMember(
  invitationData: InvitationData
): Promise<MemberManagementResult> {
  try {
    const currentUser = await getCurrentUser();
    if (!currentUser) {
      return { success: false, message: 'Not authenticated' };
    }

    const { email, role, organizationId, message } = invitationData;

    // Check permission to invite members
    requirePermission(currentUser.permissions, Permission.INVITE_MEMBERS, { organizationId });

    // Validate inputs
    if (!email || !role || !organizationId) {
      return { success: false, message: 'Missing required fields' };
    }

    if (!Object.values(OrganizationRole).includes(role)) {
      return { success: false, message: 'Invalid role specified' };
    }

    // Check if organization exists
    const organization = await prisma.organization.findUnique({
      where: { id: organizationId },
      include: {
        memberships: {
          include: { user: true },
        },
      },
    });

    if (!organization) {
      return { success: false, message: 'Organization not found' };
    }

    // Check if user is already a member
    const existingMembership = organization.memberships.find(
      (membership) => membership.user.email?.toLowerCase() === email.toLowerCase()
    );

    if (existingMembership) {
      return {
        success: false,
        message: 'User is already a member of this organization',
      };
    }

    // Check for existing pending invitation
    const existingInvitation = await prisma.organizationInvitation.findFirst({
      where: {
        organizationId,
        email: email.toLowerCase(),
        status: 'PENDING',
      },
    });

    if (existingInvitation) {
      return {
        success: false,
        message: 'Invitation already sent to this email address',
      };
    }

    // Generate invitation token
    const token = generateInvitationToken();
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7 days

    // Create invitation
    const invitation = await prisma.organizationInvitation.create({
      data: {
        organizationId,
        email: email.toLowerCase(),
        role,
        token,
        expiresAt,
        invitedById: currentUser.user.id,
        status: 'PENDING',
      },
      include: {
        organization: true,
        invitedBy: true,
      },
    });

    // Send invitation email
    await sendInvitationEmail(invitation);

    revalidatePath(`/organizations/${organizationId}/members`);

    return {
      success: true,
      message: `Invitation sent to ${email}`,
      data: { invitationId: invitation.id },
    };
  } catch (error) {
    console.error('Error inviting organization member:', error);
    return {
      success: false,
      message: 'Failed to send invitation',
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Accept an organization invitation
 */
export async function acceptOrganizationInvitation(token: string): Promise<MemberManagementResult> {
  try {
    const currentUser = await getCurrentUser();
    if (!currentUser) {
      return { success: false, message: 'Not authenticated' };
    }

    // Find invitation
    const invitation = await prisma.organizationInvitation.findUnique({
      where: { token },
      include: {
        organization: true,
        invitedBy: true,
      },
    });

    if (!invitation) {
      return { success: false, message: 'Invalid invitation token' };
    }

    if (invitation.status !== 'PENDING') {
      return {
        success: false,
        message: `Invitation has already been ${invitation.status.toLowerCase()}`,
      };
    }

    if (invitation.expiresAt < new Date()) {
      return { success: false, message: 'Invitation has expired' };
    }

    if (invitation.email.toLowerCase() !== currentUser.user.email.toLowerCase()) {
      return {
        success: false,
        message: 'This invitation is not for your email address',
      };
    }

    // Check if user is already a member
    const existingMembership = await prisma.organizationMembership.findUnique({
      where: {
        organizationId_userId: {
          organizationId: invitation.organizationId,
          userId: currentUser.user.id,
        },
      },
    });

    if (existingMembership) {
      return {
        success: false,
        message: 'You are already a member of this organization',
      };
    }

    // Create membership
    await prisma.organizationMembership.create({
      data: {
        userId: currentUser.user.id,
        organizationId: invitation.organizationId,
        role: invitation.role,
      },
    });

    // Update invitation status
    await prisma.organizationInvitation.update({
      where: { id: invitation.id },
      data: {
        status: 'ACCEPTED',
        acceptedAt: new Date(),
      },
    });

    revalidatePath(`/organizations/${invitation.organizationId}/members`);
    revalidatePath('/organizations');

    return {
      success: true,
      message: `Successfully joined ${invitation.organization.name}`,
      data: { organizationId: invitation.organizationId },
    };
  } catch (error) {
    console.error('Error accepting invitation:', error);
    return {
      success: false,
      message: 'Failed to accept invitation',
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Reject an organization invitation
 */
export async function rejectOrganizationInvitation(token: string): Promise<MemberManagementResult> {
  try {
    const invitation = await prisma.organizationInvitation.findUnique({
      where: { token },
      include: { organization: true },
    });

    if (!invitation) {
      return { success: false, message: 'Invalid invitation token' };
    }

    if (invitation.status !== 'PENDING') {
      return {
        success: false,
        message: `Invitation has already been ${invitation.status.toLowerCase()}`,
      };
    }

    await prisma.organizationInvitation.update({
      where: { id: invitation.id },
      data: {
        status: 'DECLINED',
      },
    });

    return {
      success: true,
      message: `Invitation to ${invitation.organization.name} rejected`,
    };
  } catch (error) {
    console.error('Error rejecting invitation:', error);
    return {
      success: false,
      message: 'Failed to reject invitation',
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Change a member's role in an organization
 */
export async function changeMemberRole(
  organizationId: string,
  memberId: string,
  newRole: OrganizationRole
): Promise<MemberManagementResult> {
  try {
    const currentUser = await getCurrentUser();
    if (!currentUser) {
      return { success: false, message: 'Not authenticated' };
    }

    // Check permission to manage members
    requirePermission(currentUser.permissions, Permission.MANAGE_MEMBERS, { organizationId });

    // Get the membership to be modified
    const membership = await prisma.organizationMembership.findUnique({
      where: { id: memberId },
      include: { user: true },
    });

    if (!membership || membership.organizationId !== organizationId) {
      return { success: false, message: 'Member not found' };
    }

    // Cannot change own role
    if (membership.userId === currentUser.user.id) {
      return { success: false, message: 'Cannot change your own role' };
    }

    // Get target user's permissions for validation
    const targetUserPermissions = await getUserPermissions(membership.userId);
    if (!targetUserPermissions) {
      return { success: false, message: 'Unable to validate target user permissions' };
    }

    // Check if current user can manage target user
    if (!canManageUser(currentUser.permissions, targetUserPermissions, organizationId)) {
      return {
        success: false,
        message: 'Insufficient permissions to manage this user',
      };
    }

    // Update role
    await prisma.organizationMembership.update({
      where: { id: memberId },
      data: { role: newRole },
    });

    revalidatePath(`/organizations/${organizationId}/members`);

    return {
      success: true,
      message: `Role updated for ${membership.user.email}`,
    };
  } catch (error) {
    console.error('Error changing member role:', error);
    return {
      success: false,
      message: 'Failed to change member role',
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Remove a member from an organization
 */
export async function removeMember(
  organizationId: string,
  memberId: string
): Promise<MemberManagementResult> {
  try {
    const currentUser = await getCurrentUser();
    if (!currentUser) {
      return { success: false, message: 'Not authenticated' };
    }

    requirePermission(currentUser.permissions, Permission.MANAGE_MEMBERS, { organizationId });

    const membership = await prisma.organizationMembership.findUnique({
      where: { id: memberId },
      include: { user: true },
    });

    if (!membership || membership.organizationId !== organizationId) {
      return { success: false, message: 'Member not found' };
    }

    // Cannot remove yourself
    if (membership.userId === currentUser.user.id) {
      return { success: false, message: 'Cannot remove yourself from the organization' };
    }

    // Cannot remove the last owner
    if (membership.role === OrganizationRole.OWNER) {
      const ownerCount = await prisma.organizationMembership.count({
        where: {
          organizationId,
          role: OrganizationRole.OWNER,
        },
      });

      if (ownerCount <= 1) {
        return {
          success: false,
          message: 'Cannot remove the last owner. Transfer ownership first.',
        };
      }
    }

    await prisma.organizationMembership.delete({
      where: { id: memberId },
    });

    revalidatePath(`/organizations/${organizationId}/members`);

    return {
      success: true,
      message: `${membership.user.email} removed from organization`,
    };
  } catch (error) {
    console.error('Error removing member:', error);
    return {
      success: false,
      message: 'Failed to remove member',
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Cancel a pending invitation
 */
export async function cancelInvitation(
  organizationId: string,
  invitationId: string
): Promise<MemberManagementResult> {
  try {
    const currentUser = await getCurrentUser();
    if (!currentUser) {
      return { success: false, message: 'Not authenticated' };
    }

    requirePermission(currentUser.permissions, Permission.INVITE_MEMBERS, { organizationId });

    const invitation = await prisma.organizationInvitation.findUnique({
      where: { id: invitationId },
    });

    if (!invitation || invitation.organizationId !== organizationId) {
      return { success: false, message: 'Invitation not found' };
    }

    if (invitation.status !== 'PENDING') {
      return {
        success: false,
        message: 'Can only cancel pending invitations',
      };
    }

    await prisma.organizationInvitation.update({
      where: { id: invitationId },
      data: {
        status: 'CANCELLED',
      },
    });

    revalidatePath(`/organizations/${organizationId}/members`);

    return {
      success: true,
      message: `Invitation to ${invitation.email} cancelled`,
    };
  } catch (error) {
    console.error('Error cancelling invitation:', error);
    return {
      success: false,
      message: 'Failed to cancel invitation',
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Helper function to generate invitation token
 */
function generateInvitationToken(): string {
  return crypto.randomUUID();
}

/**
 * Helper function to get user permissions (simplified)
 */
async function getUserPermissions(userId: string) {
  // This would integrate with the session helper to get user permissions
  // For now, return basic structure
  const user = await prisma.user.findUnique({
    where: { id: userId },
    include: {
      provider: true,
      organizationMemberships: true,
    },
  });

  if (!user) return null;

  return {
    systemRole: user.role as any,
    organizationRoles: user.organizationMemberships.map((membership) => ({
      organizationId: membership.organizationId,
      role: membership.role as OrganizationRole,
    })),
    providerRole: user.provider ? ('PROVIDER' as any) : undefined,
    providerId: user.provider?.id,
  };
}

/**
 * Send invitation email
 */
async function sendInvitationEmail(invitation: any): Promise<void> {
  try {
    const inviteUrl = `${process.env.NEXTAUTH_URL}/invitation/${invitation.token}`;

    await sendEmail({
      to: invitation.email,
      subject: `Invitation to join ${invitation.organization.name}`,
      template: 'organization-invitation',
      data: {
        organizationName: invitation.organization.name,
        inviterName: invitation.invitedBy.name || 'Unknown',
        role: invitation.role,
        inviteUrl,
        expiresAt: invitation.expiresAt,
      },
    });
  } catch (error) {
    console.error('Error sending invitation email:', error);
    // Don't fail the invitation if email fails
  }
}
