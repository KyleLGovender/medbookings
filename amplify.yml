version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        # Increase Node.js memory limit for large TypeScript builds
        - export NODE_OPTIONS="--max-old-space-size=6144"

        # Database operations
        # 1. RESET (DANGER - only when RESET_DATABASE=true)
        - |
          if [ "$RESET_DATABASE" = "true" ]; then
            echo "⚠️  WARNING: Resetting database - all data will be lost!"
            npx prisma migrate reset --force --skip-seed
            echo "✅ Database reset complete"
          fi

        # 2. MIGRATIONS (ALWAYS run - safe & idempotent)
        - echo "Running database migrations..."
        - npx prisma migrate deploy
        - echo "✅ Migrations complete"

        # 3. SEED (only when RUN_SEED=true)
        - |
          if [ "$RUN_SEED" = "true" ]; then
            echo "Seeding database..."
            npx prisma db seed
            echo "✅ Database seeded"
          else
            echo "ℹ️  Skipping seed (set RUN_SEED=true to seed)"
          fi

        # Export environment variables for Next.js runtime
        # NextAuth Configuration
        - export NEXTAUTH_SECRET="$NEXTAUTH_SECRET"
        - export NEXTAUTH_URL="$NEXTAUTH_URL"
        - export AUTH_SECRET="$AUTH_SECRET"

        # OAuth Providers
        - export GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID"
        - export GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET"

        # Database
        - export DATABASE_URL="$DATABASE_URL"

        # Google Services
        - export NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="$NEXT_PUBLIC_GOOGLE_MAPS_API_KEY"

        # Twilio
        - export TWILIO_ACCOUNT_SID="$TWILIO_ACCOUNT_SID"
        - export TWILIO_AUTH_TOKEN="$TWILIO_AUTH_TOKEN"
        - export TWILIO_PHONE_NUMBER="$TWILIO_PHONE_NUMBER"
        - export TWILIO_WHATSAPP_NUMBER="$TWILIO_WHATSAPP_NUMBER"

        # SendGrid
        - export SENDGRID_API_KEY="$SENDGRID_API_KEY"
        - export SENDGRID_FROM_EMAIL="$SENDGRID_FROM_EMAIL"

        # Admin
        - export ADMIN_EMAILS="$ADMIN_EMAILS"
        - export ADMIN_NOTIFICATION_EMAIL="$ADMIN_NOTIFICATION_EMAIL"

        # AWS S3
        - export S3_BUCKET_NAME="$S3_BUCKET_NAME"
        - export S3_REGION="$S3_REGION"

        # Environment
        - export NODE_ENV="production"
        - export LOG_LEVEL="$LOG_LEVEL"
        - export CLOUDWATCH_LOG_GROUP_NAME="$CLOUDWATCH_LOG_GROUP_NAME"

        # Build the Next.js application
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
