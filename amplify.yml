version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        # Increase Node.js memory limit for large TypeScript builds
        - export NODE_OPTIONS="--max-old-space-size=6144"

        # CRITICAL: Export environment variables for Lambda runtime
        # NextAuth v5 needs these values available at runtime in AWS Lambda
        # This MUST come BEFORE npm run build
        - env | grep -e AUTH_TRUST_HOST -e NEXTAUTH_SECRET >> .env.production

        # Database operations
        # 1. RESET (DANGER - only when RESET_DATABASE=true)
        - |
          if [ "$RESET_DATABASE" = "true" ]; then
            echo "⚠️  WARNING: Resetting database - all data will be lost!"
            npx prisma migrate reset --force --skip-seed
            echo "✅ Database reset complete"
          fi

        # 2. MIGRATIONS (ALWAYS run - safe & idempotent)
        - echo "Running database migrations..."
        - npx prisma migrate deploy
        - echo "✅ Migrations complete"

        # 3. SEED (only when RUN_SEED=true)
        - |
          if [ "$RUN_SEED" = "true" ]; then
            echo "Seeding database..."
            npx prisma db seed
            echo "✅ Database seeded"
          else
            echo "ℹ️  Skipping seed (set RUN_SEED=true to seed)"
          fi

        # Build the Next.js application
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
