generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                          @id @default(cuid())
  name                     String?
  email                    String?                         @unique
  emailVerified            DateTime?
  phone                    String?
  phoneVerified            DateTime?
  whatsapp                 String?
  whatsappVerified         DateTime?
  password                 String?
  passwordMigratedAt       DateTime?
  image                    String?
  role                     UserRole                        @default(USER)
  createdAt                DateTime                        @default(now())
  updatedAt                DateTime                        @updatedAt
  accountLockedUntil       DateTime?
  accounts                 Account[]
  availabilitiesAccepted   Availability[]                  @relation("AvailabilityAccepter")
  availabilitiesCreated    Availability[]
  bookingsAsClient         Booking[]                       @relation("BookingClient")
  bookingsConfirmed        Booking[]                       @relation("BookingConfirmer")
  bookingsCreated          Booking[]                       @relation("BookingCreator")
  communicationPreferences CommunicationPreference[]
  LoginAttempt             LoginAttempt[]
  organizationsApproved    Organization[]                  @relation("OrganizationApprovals")
  sentInvitations          OrganizationInvitation[]        @relation("SentInvitations")
  organizationMemberships  OrganizationMembership[]
  membershipHistoryChanges OrganizationMembershipHistory[]
  providersApproved        Provider[]                      @relation("ProviderApprovals")
  provider                 Provider?
  sentProviderInvitations  ProviderInvitation[]            @relation("ProviderInvitationsSent")
  validatedRequirements    RequirementSubmission[]         @relation("ValidatedBy")
  reviews                  Review[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model ProviderType {
  id              String                   @id @default(cuid())
  name            String                   @unique
  description     String?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  typeAssignments ProviderTypeAssignment[]
  requirements    RequirementType[]
  services        Service[]
}

model ProviderTypeAssignment {
  id             String       @id @default(cuid())
  providerId     String
  providerTypeId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  provider       Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerType   ProviderType @relation(fields: [providerTypeId], references: [id], onDelete: Cascade)

  @@unique([providerId, providerTypeId])
}

model Provider {
  id                      String                           @id @default(cuid())
  name                    String
  userId                  String                           @unique
  bio                     String?
  image                   String
  languages               Languages[]
  website                 String?
  email                   String                           @default("default@example.com")
  whatsapp                String                           @default("+1234567890")
  showPrice               Boolean                          @default(true)
  status                  ProviderStatus                   @default(PENDING_APPROVAL)
  approvedById            String?
  approvedAt              DateTime?
  rejectedAt              DateTime?
  rejectionReason         String?
  createdAt               DateTime                         @default(now())
  updatedAt               DateTime                         @updatedAt
  averageRating           Float?
  totalReviews            Int                              @default(0)
  trialStarted            DateTime?
  trialEnded              DateTime?
  trialStatus             TrialStatus?
  paymentMethodAdded      Boolean                          @default(false)
  trialReminderSent       Boolean                          @default(false)
  trialConversionDate     DateTime?
  selfPaidBookingsEnabled Boolean                          @default(false)
  reminderChannels        String[]                         @default(["email", "sms"])
  reminderEnabled         Boolean                          @default(true)
  reminderHours           Int                              @default(24)
  availabilities          Availability[]
  calendarIntegration     CalendarIntegration?
  providerConnections     OrganizationProviderConnection[]
  approvedBy              User?                            @relation("ProviderApprovals", fields: [approvedById], references: [id])
  user                    User                             @relation(fields: [userId], references: [id])
  typeAssignments         ProviderTypeAssignment[]
  requirementSubmissions  RequirementSubmission[]
  reviews                 Review[]
  availabilityConfigs     ServiceAvailabilityConfig[]
  subscriptions           Subscription[]
  services                Service[]                        @relation("ProviderToService")
}

model Organization {
  id                  String                           @id @default(cuid())
  name                String
  description         String?
  email               String?
  phone               String?
  website             String?
  logo                String?
  status              OrganizationStatus               @default(PENDING_APPROVAL)
  approvedById        String?
  approvedAt          DateTime?
  rejectedAt          DateTime?
  rejectionReason     String?
  createdAt           DateTime                         @default(now())
  updatedAt           DateTime                         @updatedAt
  billingModel        OrganizationBillingModel         @default(CONSOLIDATED)
  trialStarted        DateTime?
  trialEnded          DateTime?
  trialStatus         TrialStatus?
  paymentMethodAdded  Boolean                          @default(false)
  trialReminderSent   Boolean                          @default(false)
  trialConversionDate DateTime?
  availabilities      Availability[]
  locations           Location[]
  approvedBy          User?                            @relation("OrganizationApprovals", fields: [approvedById], references: [id])
  invitations         OrganizationInvitation[]
  memberships         OrganizationMembership[]
  providerConnections OrganizationProviderConnection[]
  providerInvitations ProviderInvitation[]
  subscriptions       Subscription[]

  @@index([name])
}

model OrganizationInvitation {
  id             String                   @id @default(cuid())
  organizationId String
  email          String
  role           OrganizationRole
  permissions    OrganizationPermission[]
  token          String                   @unique
  expiresAt      DateTime
  invitedById    String
  status         InvitationStatus         @default(PENDING)
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  acceptedAt     DateTime?
  membershipId   String?                  @unique
  invitedBy      User                     @relation("SentInvitations", fields: [invitedById], references: [id])
  membership     OrganizationMembership?  @relation(fields: [membershipId], references: [id])
  organization   Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@index([token])
}

model ProviderInvitation {
  id                  String                          @id @default(cuid())
  organizationId      String
  email               String
  customMessage       String?
  token               String                          @unique
  expiresAt           DateTime
  invitedById         String
  status              ProviderInvitationStatus        @default(PENDING)
  createdAt           DateTime                        @default(now())
  updatedAt           DateTime                        @updatedAt
  acceptedAt          DateTime?
  rejectedAt          DateTime?
  cancelledAt         DateTime?
  rejectionReason     String?
  connectionId        String?                         @unique
  emailDeliveryStatus String?                         @default("PENDING")
  lastEmailSentAt     DateTime?
  emailAttempts       Int                             @default(0)
  connection          OrganizationProviderConnection? @relation(fields: [connectionId], references: [id])
  invitedBy           User                            @relation("ProviderInvitationsSent", fields: [invitedById], references: [id])
  organization        Organization                    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
}

model OrganizationMembership {
  id                    String                          @id @default(cuid())
  organizationId        String
  userId                String
  role                  OrganizationRole
  permissions           OrganizationPermission[]
  status                MembershipStatus                @default(ACTIVE)
  createdAt             DateTime                        @default(now())
  updatedAt             DateTime                        @updatedAt
  availabilitiesCreated Availability[]                  @relation("CreatedByOrgMember")
  bookingsCreated       Booking[]                       @relation("BookedByOrgMember")
  invitation            OrganizationInvitation?
  organization          Organization                    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                  User                            @relation(fields: [userId], references: [id], onDelete: Cascade)
  history               OrganizationMembershipHistory[]

  @@unique([organizationId, userId])
  @@index([userId])
}

model OrganizationMembershipHistory {
  id             String                   @id @default(cuid())
  membershipId   String
  changeType     MembershipChangeType
  oldRole        OrganizationRole?
  newRole        OrganizationRole?
  oldPermissions OrganizationPermission[]
  newPermissions OrganizationPermission[]
  oldStatus      MembershipStatus?
  newStatus      MembershipStatus?
  changedById    String
  changeReason   String?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime                 @default(now())
  changedBy      User                     @relation(fields: [changedById], references: [id])
  membership     OrganizationMembership   @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@index([membershipId, createdAt])
  @@index([changedById, createdAt])
  @@index([changeType, createdAt])
}

model Location {
  id                    String                      @id @default(cuid())
  organizationId        String
  name                  String
  googlePlaceId         String                      @unique
  formattedAddress      String
  coordinates           Json
  phone                 String?
  email                 String?
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  searchTerms           String[]
  availabilities        Availability[]
  organization          Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  serviceConfigurations ServiceAvailabilityConfig[]
  subscriptions         Subscription[]

  @@index([organizationId])
  @@index([searchTerms])
}

model OrganizationProviderConnection {
  id              String              @id @default(cuid())
  organizationId  String
  status          ConnectionStatus    @default(PENDING)
  defaultBilledBy BillingEntity       @default(ORGANIZATION)
  requestedAt     DateTime            @default(now())
  acceptedAt      DateTime?
  providerId      String
  availabilities  Availability[]
  organization    Organization        @relation(fields: [organizationId], references: [id])
  provider        Provider            @relation(fields: [providerId], references: [id])
  invitation      ProviderInvitation?

  @@unique([organizationId, providerId])
  @@index([providerId])
  @@index([organizationId])
}

model Subscription {
  id                       String                       @id @default(cuid())
  organizationId           String?
  locationId               String?
  status                   SubscriptionStatus
  type                     SubscriptionType             @default(BASE)
  planId                   String
  isActive                 Boolean                      @default(true)
  trialStart               DateTime?
  trialEnd                 DateTime?
  startDate                DateTime
  endDate                  DateTime?
  cancelledAt              DateTime?
  cancelReason             String?
  stripeCustomerId         String?
  stripeSubscriptionId     String?
  currentMonthSlots        Int                          @default(0)
  billingCycleStart        DateTime
  billingCycleEnd          DateTime
  createdAt                DateTime                     @default(now())
  updatedAt                DateTime                     @updatedAt
  providerId               String?
  defaultForAvailabilities Availability[]
  billedSlots              CalculatedAvailabilitySlot[] @relation("BilledSlots")
  payments                 Payment[]
  location                 Location?                    @relation(fields: [locationId], references: [id])
  organization             Organization?                @relation(fields: [organizationId], references: [id])
  plan                     SubscriptionPlan             @relation(fields: [planId], references: [id])
  provider                 Provider?                    @relation(fields: [providerId], references: [id])
  usageRecords             UsageRecord[]

  @@index([organizationId, startDate])
}

model SubscriptionPlan {
  id            String          @id @default(cuid())
  name          String
  description   String?
  /// @zod.custom.use(z.number().positive()) // e.g., R300
  basePrice     Decimal         @db.Decimal(10, 2)
  currency      String          @default("ZAR")
  interval      BillingInterval
  includedSlots Int             @default(30)
  tierPricing   Json
  features      Json?
  maxProviders  Int?
  maxLocations  Int?
  isActive      Boolean         @default(true)
  stripePriceId String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  subscriptions Subscription[]
}

model UsageRecord {
  id             String       @id @default(cuid())
  subscriptionId String
  slotId         String
  slotDate       DateTime
  slotStatus     SlotStatus
  billingCycle   String
  serviceId      String
  tierUsed       Int
  /// @zod.custom.use(z.number().positive())
  priceCharged   Decimal      @db.Decimal(10, 2)
  processed      Boolean      @default(false)
  processedAt    DateTime?
  createdAt      DateTime     @default(now())
  providerId     String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId, billingCycle])
  @@index([processed, billingCycle])
  @@index([slotId])
}

model Payment {
  id                 String        @id @default(cuid())
  subscriptionId     String
  /// @zod.custom.use(z.number().positive())
  amount             Decimal       @db.Decimal(10, 2)
  /// @zod.custom.use(z.number().positive()) // Base subscription fee
  baseAmount         Decimal?      @db.Decimal(10, 2)
  /// @zod.custom.use(z.number().positive()) // Usage-based charges
  usageAmount        Decimal?      @db.Decimal(10, 2)
  currency           String
  status             PaymentStatus
  stripePaymentId    String?
  stripeInvoiceId    String?
  paidAt             DateTime?
  failureReason      String?
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?
  slotsCovered       Int?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  subscription       Subscription  @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId, billingPeriodStart])
}

model RequirementType {
  id               String                    @id @default(cuid())
  name             String
  description      String?
  isRequired       Boolean                   @default(true)
  validationType   RequirementValidationType
  validationConfig Json?
  displayPriority  Int                       @default(0)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  providerTypeId   String
  submissions      RequirementSubmission[]
  providerType     ProviderType              @relation(fields: [providerTypeId], references: [id])
}

model RequirementSubmission {
  id                String                       @id @default(cuid())
  requirementTypeId String
  status            RequirementsValidationStatus @default(PENDING)
  documentMetadata  Json?
  expiresAt         DateTime?
  notes             String?
  validatedAt       DateTime?
  validatedById     String?
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt
  providerId        String
  provider          Provider                     @relation(fields: [providerId], references: [id])
  requirementType   RequirementType              @relation(fields: [requirementTypeId], references: [id])
  validatedBy       User?                        @relation("ValidatedBy", fields: [validatedById], references: [id])

  @@unique([requirementTypeId, providerId])
}

model Service {
  id                  String                       @id @default(cuid())
  name                String
  description         String?
  displayPriority     Int                          @default(0)
  defaultDuration     Int
  /// @zod.custom.use(z.number().positive())
  defaultPrice        Decimal                      @db.Decimal(10, 2)
  createdAt           DateTime                     @default(now())
  updatedAt           DateTime                     @updatedAt
  providerTypeId      String
  calculatedSlots     CalculatedAvailabilitySlot[]
  providerType        ProviderType                 @relation(fields: [providerTypeId], references: [id])
  availabilityConfigs ServiceAvailabilityConfig[]
  providers           Provider[]                   @relation("ProviderToService")

  @@index([providerTypeId, displayPriority])
}

model ServiceAvailabilityConfig {
  id                String                       @id @default(cuid())
  serviceId         String
  duration          Int
  /// @zod.custom.use(z.number().positive())
  price             Decimal                      @db.Decimal(10, 2)
  isOnlineAvailable Boolean                      @default(false)
  isInPerson        Boolean                      @default(false)
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt
  locationId        String?
  providerId        String
  calculatedSlots   CalculatedAvailabilitySlot[]
  location          Location?                    @relation(fields: [locationId], references: [id])
  provider          Provider                     @relation(fields: [providerId], references: [id])
  service           Service                      @relation(fields: [serviceId], references: [id])
  availabilities    Availability[]               @relation("AvailabilityToServiceAvailabilityConfig")

  @@index([providerId])
  @@index([locationId])
}

model Availability {
  id                    String                          @id @default(cuid())
  organizationId        String?
  locationId            String?
  connectionId          String?
  startTime             DateTime
  endTime               DateTime
  createdById           String
  createdByMembershipId String?
  isProviderCreated     Boolean                         @default(false)
  status                AvailabilityStatus              @default(PENDING)
  acceptedById          String?
  acceptedAt            DateTime?
  requiresConfirmation  Boolean                         @default(true)
  billingEntity         BillingEntity?
  defaultSubscriptionId String?
  createdAt             DateTime                        @default(now())
  updatedAt             DateTime                        @updatedAt
  isOnlineAvailable     Boolean                         @default(false)
  isRecurring           Boolean                         @default(false)
  recurrencePattern     Json?
  schedulingInterval    Int?
  schedulingRule        SchedulingRule                  @default(CONTINUOUS)
  seriesId              String?
  providerId            String
  acceptedBy            User?                           @relation("AvailabilityAccepter", fields: [acceptedById], references: [id])
  providerConnection    OrganizationProviderConnection? @relation(fields: [connectionId], references: [id])
  createdBy             User                            @relation(fields: [createdById], references: [id])
  createdByMembership   OrganizationMembership?         @relation("CreatedByOrgMember", fields: [createdByMembershipId], references: [id])
  defaultSubscription   Subscription?                   @relation(fields: [defaultSubscriptionId], references: [id])
  location              Location?                       @relation(fields: [locationId], references: [id])
  organization          Organization?                   @relation(fields: [organizationId], references: [id])
  provider              Provider                        @relation(fields: [providerId], references: [id])
  calculatedSlots       CalculatedAvailabilitySlot[]
  availableServices     ServiceAvailabilityConfig[]     @relation("AvailabilityToServiceAvailabilityConfig")

  @@index([providerId, startTime, endTime])
  @@index([organizationId, status])
  @@index([connectionId])
  @@index([billingEntity, organizationId])
  @@index([seriesId])
}

model CalculatedAvailabilitySlot {
  id                     String                    @id @default(cuid())
  availabilityId         String
  serviceId              String
  serviceConfigId        String
  startTime              DateTime
  endTime                DateTime
  status                 SlotStatus                @default(AVAILABLE)
  lastCalculated         DateTime
  billedToSubscriptionId String?
  blockedByEventId       String?
  version                Int                       @default(1)
  createdAt              DateTime                  @default(now())
  updatedAt              DateTime                  @updatedAt
  booking                Booking?
  availability           Availability              @relation(fields: [availabilityId], references: [id])
  billedToSubscription   Subscription?             @relation("BilledSlots", fields: [billedToSubscriptionId], references: [id])
  blockedByCalendarEvent CalendarEvent?            @relation("BlockedByCalendarEvent", fields: [blockedByEventId], references: [id])
  serviceConfig          ServiceAvailabilityConfig @relation(fields: [serviceConfigId], references: [id])
  service                Service                   @relation(fields: [serviceId], references: [id])

  @@index([availabilityId, serviceId, startTime, status])
  @@index([startTime, status, serviceId])
}

model Booking {
  id                    String                      @id @default(cuid())
  slotId                String?                     @unique
  createdById           String?
  createdByMembershipId String?
  isProviderCreated     Boolean                     @default(false)
  isGuestBooking        Boolean                     @default(false)
  isGuestSelfBooking    Boolean                     @default(false)
  confirmedById         String?
  confirmedAt           DateTime?
  clientId              String?
  guestName             String?
  guestEmail            String?
  guestPhone            String?
  guestWhatsapp         String?
  /// @zod.custom.use(z.number().positive())
  price                 Decimal                     @db.Decimal(10, 2)
  isOnline              Boolean
  isInPerson            Boolean                     @default(false)
  status                BookingStatus               @default(PENDING)
  notes                 String?
  meetLink              String?
  calendarEventId       String?
  version               Int                         @default(1)
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  client                User?                       @relation("BookingClient", fields: [clientId], references: [id])
  confirmedBy           User?                       @relation("BookingConfirmer", fields: [confirmedById], references: [id])
  createdBy             User?                       @relation("BookingCreator", fields: [createdById], references: [id])
  createdByMembership   OrganizationMembership?     @relation("BookedByOrgMember", fields: [createdByMembershipId], references: [id])
  slot                  CalculatedAvailabilitySlot? @relation(fields: [slotId], references: [id])
  communications        CommunicationLog[]
  meetSession           MeetSession?
  review                Review?

  @@index([slotId, status])
  @@index([clientId, createdAt])
  @@index([createdByMembershipId])
  @@index([createdById, status])
  @@index([status, createdAt])
}

model CommunicationPreference {
  id             String   @id @default(cuid())
  userId         String
  email          Boolean  @default(true)
  sms            Boolean  @default(false)
  whatsapp       Boolean  @default(false)
  phoneNumber    String?
  whatsappNumber String?
  reminderHours  Int      @default(24)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
}

model CommunicationLog {
  id                  String               @id @default(cuid())
  bookingId           String?
  bookingReference    String?
  serviceProviderName String?
  clientName          String?
  serviceName         String?
  appointmentTime     DateTime?
  type                CommunicationType
  channel             CommunicationChannel
  content             String
  status              String
  sentAt              DateTime             @default(now())
  deliveredAt         DateTime?
  booking             Booking?             @relation(fields: [bookingId], references: [id])
}

model CalendarIntegration {
  id                    String                  @id @default(cuid())
  accessToken           String
  refreshToken          String
  expiresAt             DateTime
  calendarId            String?
  syncEnabled           Boolean                 @default(true)
  lastSyncedAt          DateTime?
  googleEmail           String?
  grantedScopes         String[]
  meetSettings          Json?
  webhookChannelId      String?
  webhookResourceId     String?
  webhookExpiresAt      DateTime?
  nextSyncToken         String?
  syncDirection         CalendarSyncDirection   @default(BIDIRECTIONAL)
  blockingEventTypes    String[]
  autoCreateMeetLinks   Boolean                 @default(true)
  backgroundSyncEnabled Boolean                 @default(true)
  syncIntervalMinutes   Int                     @default(15)
  lastFullSyncAt        DateTime?
  syncFailureCount      Int                     @default(0)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  calendarProvider      String
  providerId            String                  @unique
  calendarEvents        CalendarEvent[]
  provider              Provider                @relation(fields: [providerId], references: [id])
  syncOperations        CalendarSyncOperation[]
}

model CalendarEvent {
  id                     String                       @id @default(cuid())
  calendarIntegrationId  String
  externalEventId        String
  externalCalendarId     String
  etag                   String?
  title                  String
  startTime              DateTime
  endTime                DateTime
  isAllDay               Boolean                      @default(false)
  lastSyncedAt           DateTime                     @default(now())
  eventType              String?
  blocksAvailability     Boolean                      @default(true)
  syncStatus             CalendarEventSyncStatus      @default(SYNCED)
  lastModifiedInExternal DateTime?
  hasConflict            Boolean                      @default(false)
  conflictDetails        String?
  conflictResolvedAt     DateTime?
  version                Int                          @default(1)
  createdAt              DateTime                     @default(now())
  updatedAt              DateTime                     @updatedAt
  blockedSlots           CalculatedAvailabilitySlot[] @relation("BlockedByCalendarEvent")
  calendarIntegration    CalendarIntegration          @relation(fields: [calendarIntegrationId], references: [id])

  @@unique([calendarIntegrationId, externalEventId])
  @@index([calendarIntegrationId, startTime, endTime])
  @@index([syncStatus, hasConflict])
  @@index([lastSyncedAt])
}

model CalendarSyncOperation {
  id                    String                    @id @default(cuid())
  calendarIntegrationId String
  operationType         CalendarSyncOperationType
  sourceSystem          CalendarSyncSource
  status                CalendarSyncStatus        @default(PENDING)
  entityType            CalendarEntityType
  entityId              String?
  externalEventId       String?
  startedAt             DateTime                  @default(now())
  completedAt           DateTime?
  retryCount            Int                       @default(0)
  maxRetries            Int                       @default(3)
  errorMessage          String?
  conflictResolution    ConflictResolution?
  syncWindowStart       DateTime?
  syncWindowEnd         DateTime?
  eventsProcessed       Int                       @default(0)
  eventsSucceeded       Int                       @default(0)
  eventsFailed          Int                       @default(0)
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  calendarIntegration   CalendarIntegration       @relation(fields: [calendarIntegrationId], references: [id])

  @@index([calendarIntegrationId, status])
  @@index([operationType, startedAt])
  @@index([status, retryCount])
}

model MeetSession {
  id        String            @id @default(cuid())
  bookingId String            @unique
  meetLink  String
  eventId   String
  joinCode  String?
  status    MeetSessionStatus @default(SCHEDULED)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  booking   Booking           @relation(fields: [bookingId], references: [id])
}

model Review {
  id             String       @id @default(cuid())
  clientId       String
  bookingId      String       @unique
  rating         Int
  comment        String?
  response       String?
  isPublic       Boolean      @default(true)
  googleReviewId String?
  status         ReviewStatus @default(PENDING)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  providerId     String
  booking        Booking      @relation(fields: [bookingId], references: [id])
  client         User         @relation(fields: [clientId], references: [id])
  provider       Provider     @relation(fields: [providerId], references: [id])

  @@index([providerId, status])
  @@index([clientId, createdAt])
}

model EmailVerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@index([token])
  @@index([identifier])
}

model AuditLog {
  id         String        @id @default(cuid())
  userId     String?
  userEmail  String?
  action     String
  category   AuditCategory @default(GENERAL)
  resource   String?
  resourceId String?
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime      @default(now())

  @@index([userId, createdAt])
  @@index([category, createdAt])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@index([action, createdAt])
}

model LoginAttempt {
  id            String   @id
  userId        String?
  email         String
  ipAddress     String?
  userAgent     String?
  success       Boolean  @default(false)
  failureReason String?
  createdAt     DateTime @default(now())
  User          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@index([userId, createdAt])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum ProviderStatus {
  PENDING_APPROVAL
  REJECTED
  APPROVED
  TRIAL
  TRIAL_EXPIRED
  ACTIVE
  PAYMENT_OVERDUE
  SUSPENDED
  CANCELLED
}

enum TrialStatus {
  NOT_STARTED
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  CONVERTED
}

enum SubscriptionType {
  BASE
  WEBSITE_HOSTING
  REVIEW_PROMOTION
  PREMIUM_ANALYTICS
  CUSTOM
}

enum Languages {
  English
  IsiZulu
  IsiXhosa
  Afrikaans
  Sepedi
  Setswana
  Sesotho
  IsiNdebele
  SiSwati
  Tshivenda
  Xitsonga
  Portuguese
  French
  Hindi
  German
  Mandarin
}

enum OrganizationBillingModel {
  CONSOLIDATED
  PER_LOCATION
}

enum OrganizationStatus {
  PENDING_APPROVAL
  REJECTED
  APPROVED
  TRIAL
  TRIAL_EXPIRED
  ACTIVE
  PAYMENT_OVERDUE
  SUSPENDED
  CANCELLED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

enum ProviderInvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
  EXPIRED
  DELIVERY_FAILED
}

enum OrganizationRole {
  OWNER
  ADMIN
  MANAGER
  STAFF
}

enum OrganizationPermission {
  MANAGE_PROVIDERS
  MANAGE_BOOKINGS
  MANAGE_LOCATIONS
  MANAGE_STAFF
  VIEW_ANALYTICS
  MANAGE_BILLING
  RESPOND_TO_MESSAGES
  MANAGE_AVAILABILITY
}

enum MembershipStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum MembershipChangeType {
  CREATED
  ROLE_CHANGED
  PERMISSIONS_CHANGED
  STATUS_CHANGED
  DELETED
  INVITATION_SENT
  INVITATION_ACCEPTED
  INVITATION_REJECTED
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  SUSPENDED
}

enum BillingEntity {
  ORGANIZATION
  LOCATION
  PROVIDER
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
  TRIALING
}

enum BillingInterval {
  MONTHLY
}

enum RequirementValidationType {
  BOOLEAN
  DOCUMENT
  TEXT
  DATE
  FUTURE_DATE
  PAST_DATE
  NUMBER
  PREDEFINED_LIST
}

enum RequirementsValidationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AvailabilityStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum SchedulingRule {
  CONTINUOUS
  ON_THE_HOUR
  ON_THE_HALF_HOUR
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED
  INVALID
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum CommunicationType {
  BOOKING_CONFIRMATION
  BOOKING_REMINDER
  BOOKING_CANCELLATION
  BOOKING_MODIFICATION
}

enum CommunicationChannel {
  EMAIL
  SMS
  WHATSAPP
}

enum CalendarEventSyncStatus {
  SYNCED
  PENDING_SYNC
  SYNC_FAILED
  CONFLICT_DETECTED
  EXTERNAL_DELETED
}

enum CalendarSyncDirection {
  IMPORT_ONLY
  EXPORT_ONLY
  BIDIRECTIONAL
}

enum CalendarSyncOperationType {
  FULL_SYNC
  INCREMENTAL_SYNC
  WEBHOOK_SYNC
  MANUAL_SYNC
  CONFLICT_RESOLUTION
}

enum CalendarSyncSource {
  MEDBOOKINGS
  GOOGLE_CALENDAR
  SYSTEM
}

enum CalendarSyncStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  CONFLICT_DETECTED
  SKIPPED
}

enum CalendarEntityType {
  BOOKING
  CALENDAR_EVENT
  AVAILABILITY_SLOT
}

enum ConflictResolution {
  GOOGLE_WINS
  MEDBOOKINGS_WINS
  MANUAL_REVIEW
  LATEST_WINS
}

enum MeetSessionStatus {
  SCHEDULED
  STARTED
  ENDED
  CANCELLED
}

enum ReviewStatus {
  PENDING
  PUBLISHED
  HIDDEN
  FLAGGED
  SYNCED
}

enum AuditCategory {
  AUTHENTICATION
  AUTHORIZATION
  PHI_ACCESS
  ADMIN_ACTION
  DATA_MODIFICATION
  SECURITY
  GENERAL
}
